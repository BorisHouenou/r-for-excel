--
always_allow_html: true
--

# Synthesis {#synthesis}

## Summary

In this session, we'll pull together the skills that we've learned so far. Working in our existing collaborative project/repo from the previous session (`r-collab`), we'll wrangle and visualize data from spreadsheets in R Markdown, communicate between RStudio (locally) and GitHub (remotely) to keep our updates safe, then add something new to our collaborator's document. And we'll learn a few new things along the way! 

**Data used in the synthesis section:**
File name: noaa_fisheries.csv
Description: NOAA Commercial Fisheries Landing data (1950 - 2017)
Accessed from: https://www.st.nmfs.noaa.gov/commercial-fisheries/commercial-landings/
Source: Fisheries Statistics Division of the NOAA Fisheries

*Note on the data:* "aggregate" here means "These names represent aggregations of more than one species. They are not inclusive, but rather represent landings where we do not have species-specific data. Selecting "Sharks", for example, will not return all sharks but only those where we do not have more specific information."

## Objectives

- Synthesize data wrangling and visualization skills learned so far
- Add a few new tools for data cleaning from `stringr`
- Add an image to your collaborator's .Rmd
- Publish your collaborative work as a webpage

## Resources

- [Project oriented workflows](https://www.tidyverse.org/blog/2017/12/workflow-vs-script/) by Jenny Bryan

## Attach packages, read in and explore the data

In **your** .Rmd that you created in the last session (TODO: name of that .Rmd here? If already created?), attach (load) packages with `library()`:

```{r, message = FALSE, warning = FALSE}

library(tidyverse)
library(here)  
library(janitor) 
library(kableExtra)

```


Read in the noaa_landings.csv data as object **us_landings**. Note that cells we want to be stored as `NA` actually have the words "no data" - but we can include an additional argument in `read_csv()` to specify what we want to replace with `NA`.

```{r, message = FALSE}
us_landings <- read_csv(here("data","noaa_landings.csv"),
                        na = "no data")
```

Go exploring a bit:
```{r, eval = FALSE}
summary(us_landings)
View(us_landings)
names(us_landings)
head(us_landings)
tail(us_landings)
```

## Some data cleaning to get salmon landings

- Clean up column names (`clean_names()`)
- Convert everything to lower case with `mutate()` + (`str_to_lower()`)
- Remove dollar signs in value column (`mutate()` + `parse_number()`)
- Remove the "aggregate" grouping indicator in species (`mutate()` + a new function! `str_remove()`) %>% 
- Keep only observations that include "salmon" (`filter()`)
- Separate the grouped name ("salmon") from any additional refined information on species (`separate()`)

We'll break this up into two pieces:

1. A tidier version of the entire data frame
2. A subset that only contains salmon information

First: tidying the entire data frame
```{r}
landings_tidy <- us_landings %>% 
  clean_names() %>% # Make column headers snake_case
  mutate(
    state = str_to_lower(state),
    afs_name = str_to_lower(afs_name)
  ) %>% # Converts character columns to lowercase
  mutate(dollars_num = parse_number(dollars_usd))
```

Now, getting just the salmon:
```{r}
salmon_landings <- landings_tidy %>% 
  mutate(afs_clean = str_remove(afs_name, pattern = "aggregate")) %>% 
  filter(str_detect(afs_clean, pattern = "salmon")) %>% 
  separate(afs_clean, into = c("group","species"), sep = ", ") 

# Note that the separator is 'comma-SPACE', to remove the space here & avoid having names like " coho" later on (though you could do it later)

```

Explore **salmon_landings**. 

## Find grouped summary data

Find the annual total US landings and dollar value (summing across all states) for each type of salmon using `group_by()` + `summarize()`:

```{r}

salmon_summary <- salmon_landings %>% 
  group_by(year, species) %>% 
  summarize(
    tot_landings = sum(landings_pounds),
    tot_value = sum(dollars_num)
  )

```

## Make a graph of US commercial fisheries value by species over time with `ggplot2`

```{r, warning = FALSE}
salmon_landings_graph <- 
  ggplot(salmon_summary, 
         aes(x = year, y = tot_landings, group = species)) +
  geom_line(aes(color = species)) +
  theme_bw() +
  labs(x = "year", y = "US commercial salmon landings (pounds)")

salmon_landings_graph
```

## Export your salmon value graph with `ggsave`

```{r, eval = FALSE}
ggsave(plot = salmon_landings_graph, 
       here("figures", "us_salmon_landings.png"),
       height = 5, 
       width = 8)
```

## `pivot_wider` to make a table with years as columns

Finally, we'll create a table with the most recent 5 years of data (2013 - 2017) as columns, and the species (only coho & sockeye) as rows. 

Starting from `salmon_summary`, let's: 

- Filter to only include years 2013 - 2017, for coho & sockeye salmon
- Add a new column that is landings in *millions* of pounds (instead of pounds)
- Round pounds to 2 digits
- Remove the original *tot_landings* and *tot_value* columns
- `pivot_wider()` to get years as columns
- Finalize a nice data frame of landings for the two species
- Publish as an HTML table with `kable()` and `kableExtra`

### Wrangle to create our subset from salmon_data

```{r}
salmon_table <- salmon_summary %>% 
  filter(year >= 2013, species %in% c("coho", "sockeye")) %>% 
  mutate(tot_landings_mil = round(tot_landings / 1e6,2)) %>% 
  select(-tot_value, -tot_landings) %>% 
  pivot_wider(names_from = year, values_from = tot_landings_mil) %>% 
  mutate(species = str_to_sentence(species)) %>% 
  rename(`Salmon species` = species)
```

### Make our HTML table

```{r, eval=FALSE}
kable(salmon_table) %>% 
  kable_styling(full_width = FALSE) %>% 
  add_header_above(c(" " = 1, "US salmon landings (million pounds)" = 5))
```

## Sync with GitHub remote

Stage, commit, (pull), and push your updates to GitHub for safe storage & sharing. Check to make sure that the changes have been stored. 

## Add an image to your partner's document

Now, let's add an image to our **partner's** .Rmd.

First: 

- Pull again to make sure you have your partner's most updated versions
- Open your **partner's** .Rmd

Second: 

- Pull again to make sure you have everyone's most updated versions
- Open your **partner's** .Rmd ()
- Go to [octodex.github.com](https://octodex.github.com/) and find a version of octocat that you love
- On the image, right click and choose "Copy image location"
- In your **partner's** .Rmd, add the image at the end using:

`!()[paste_image_location_you_just_copied_here]`

- Knit the .Rmd and check to ensure that **your** octocat shows up in **their** document
- Save, stage, commit, pull, then push to send your contributions back
- Pull again to make sure **your** .Rmd has updates from **your collaborator**
- Check out out your document as a website published with gh-pages! 

### End synthesis session!

